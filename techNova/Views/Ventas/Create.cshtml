@model techNova.Models.Venta

@{
    ViewData["Title"] = "Registrar Venta";
    var productos = ViewBag.Productos as List<techNova.Models.Producto>;
}

<div class="mb-6 flex items-center gap-3">
    <div class="h-10 w-10 rounded-2xl bg-neutral-900 flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg"
             class="h-5 w-5 text-neutral-50"
             viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 3h18l-1.5 9h-15z" />
            <circle cx="8.5" cy="19.5" r="1.5" />
            <circle cx="17.5" cy="19.5" r="1.5" />
        </svg>
    </div>
    <div>
        <h1 class="text-2xl md:text-3xl font-semibold text-neutral-900">Registrar nueva venta</h1>
        <p class="text-xs text-neutral-500 mt-0.5">
            Selecciona el cliente y agrega los productos a la venta.
        </p>
    </div>
</div>

<div class="bg-white shadow-sm border border-neutral-200 rounded-2xl p-6 md:p-8 space-y-6">

    <!-- RESUMEN DE ERRORES -->
    @if (!ViewData.ModelState.IsValid && ViewData.ModelState.Values.SelectMany(v => v.Errors).Any())
    {
        <div class="mb-4 rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-800">
            <p class="font-semibold mb-1">Revisa los siguientes errores:</p>
            <ul class="list-disc pl-5 space-y-1">
                @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                {
                    <li>@error.ErrorMessage</li>
                }
            </ul>
        </div>
    }

    <form asp-action="Create" method="post" class="space-y-6">

        <!-- CLIENTE -->
        <div class="space-y-1.5">
            <label asp-for="ClienteId" class="text-xs font-semibold tracking-wide text-neutral-700 uppercase"></label>
            <select asp-for="ClienteId"
                    asp-items="ViewBag.ClienteId"
                    class="w-full px-3 py-2 rounded-xl border border-neutral-200 bg-neutral-50 text-sm
                           focus:outline-none focus:ring-2 focus:ring-neutral-900 focus:border-neutral-900">
                <option value="">Seleccione un cliente...</option>
            </select>
            <span asp-validation-for="ClienteId" class="text-xs text-rose-600"></span>
        </div>

        <!-- TABLA DE PRODUCTOS -->
        <div>
            <div class="flex items-center justify-between mb-3">
                <div>
                    <h2 class="text-sm font-semibold text-neutral-900">Productos</h2>
                    <p class="text-xs text-neutral-500">Agrega uno o varios productos a esta venta.</p>
                </div>
            </div>

            <div class="overflow-hidden border border-neutral-200 rounded-2xl">
                <table class="min-w-full text-sm" id="tablaProductos">
                    <thead class="bg-neutral-900 text-xs font-medium text-neutral-200 uppercase tracking-wide">
                        <tr>
                            <th class="px-3 py-2 text-left">Producto</th>
                            <th class="px-3 py-2 text-left">Precio</th>
                            <th class="px-3 py-2 text-left">Cantidad</th>
                            <th class="px-3 py-2 text-left">Subtotal</th>
                            <th class="px-3 py-2"></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-neutral-100"></tbody>
                </table>
            </div>

            <button type="button"
                    onclick="agregarFila()"
                    class="mt-4 inline-flex items-center px-4 py-2 rounded-xl bg-neutral-900 text-neutral-50 text-sm font-medium
                           shadow-sm hover:bg-neutral-800 transition">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="h-4 w-4 mr-1.5"
                     viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 5v14" />
                    <path d="M5 12h14" />
                </svg>
                Agregar producto
            </button>
        </div>

        <!-- TOTAL -->
        <div class="flex justify-end">
            <div class="inline-flex items-baseline gap-2 px-4 py-3 rounded-2xl bg-neutral-900 text-neutral-50">
                <span class="text-xs font-semibold uppercase tracking-wide">Total</span>
                <span class="text-2xl font-bold">$<span id="totalVenta">0</span></span>
            </div>
        </div>

        <!-- BOTONES -->
        <div class="flex justify-end gap-3 pt-2">
            <a asp-action="Index"
               class="inline-flex items-center px-4 py-2 rounded-xl border border-neutral-300 text-neutral-800 text-sm
                      bg-white hover:bg-neutral-100 transition">
                Cancelar
            </a>

            <button type="submit"
                    class="inline-flex items-center px-6 py-2 rounded-xl bg-neutral-900 text-neutral-50 text-sm font-medium
                           shadow-sm hover:bg-neutral-800 transition">
                Guardar venta
            </button>
        </div>

    </form>

</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        let productos = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(productos));

        function agregarFila() {
            const tbody = document.querySelector("#tablaProductos tbody");

            const fila = document.createElement("tr");
            fila.className = "hover:bg-neutral-50 transition";

            fila.innerHTML = `
                <td class="px-3 py-2">
                    <select name="ProductosSeleccionados"
                            class="productoSelect w-full px-2 py-1 rounded-lg border border-neutral-200 bg-neutral-50 text-sm">
                        <option value="">Seleccione...</option>
                        ${productos.map(p =>
                            `<option value="${p.Id}" data-stock="${p.Stock}">
                                ${p.Nombre} (Stock: ${p.Stock})
                            </option>`
                        ).join("")}
                    </select>
                </td>
                <td class="px-3 py-2">
                    <input type="number"
                           class="precio w-24 px-2 py-1 rounded-lg border border-neutral-200 bg-neutral-50 text-sm"
                           readonly />
                </td>
                <td class="px-3 py-2">
                    <input type="number" name="Cantidades" value="1" min="1"
                           class="cantidad w-20 px-2 py-1 rounded-lg border border-neutral-200 bg-neutral-50 text-sm" />
                </td>
                <td class="px-3 py-2">
                    <input type="number"
                           class="subtotal w-24 px-2 py-1 rounded-lg border border-neutral-200 bg-neutral-50 text-sm"
                           readonly />
                </td>
                <td class="px-3 py-2 text-right">
                    <button type="button"
                            class="inline-flex items-center text-xs font-semibold text-rose-600 hover:text-rose-700"
                            onclick="eliminarFila(this)">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-4 w-4"
                             viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2"
                             stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </td>
            `;

            tbody.appendChild(fila);
            configurarEventosFila(fila);
        }

        function configurarEventosFila(fila) {
            const select = fila.querySelector(".productoSelect");
            const precio = fila.querySelector(".precio");
            const cantidad = fila.querySelector(".cantidad");
            const subtotal = fila.querySelector(".subtotal");

            let stockDisponible = 0;

            select.addEventListener("change", () => {
                const id = select.value;
                const prod = productos.find(x => x.Id == id);

                if (prod) {
                    precio.value = prod.PrecioUnitario;
                    stockDisponible = prod.Stock;
                    cantidad.max = stockDisponible;
                    if (!cantidad.value || cantidad.value <= 0) {
                        cantidad.value = 1;
                    }
                } else {
                    precio.value = "";
                    stockDisponible = 0;
                    cantidad.value = 0;
                    cantidad.removeAttribute("max");
                }

                calcularSubtotal();
            });

            cantidad.addEventListener("input", () => {
                let c = parseInt(cantidad.value || 0);

                if (stockDisponible > 0 && c > stockDisponible) {
                    alert(`No hay stock suficiente. Disponible: ${stockDisponible}`);
                    cantidad.value = stockDisponible;
                    c = stockDisponible;
                }

                if (c < 1) {
                    cantidad.value = 1;
                    c = 1;
                }

                calcularSubtotal();
            });

            function calcularSubtotal() {
                const p = parseFloat(precio.value || 0);
                const c = parseFloat(cantidad.value || 0);
                subtotal.value = (p * c).toFixed(2);
                calcularTotal();
            }
        }

        function eliminarFila(btn) {
            btn.closest("tr").remove();
            calcularTotal();
        }

        function calcularTotal() {
            let total = 0;
            document.querySelectorAll(".subtotal").forEach(s => {
                total += parseFloat(s.value || 0);
            });
            document.getElementById("totalVenta").innerText = total.toFixed(2);
        }
    </script>
}
